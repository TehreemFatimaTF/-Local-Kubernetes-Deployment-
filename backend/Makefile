# Makefile for FastAPI Docker Development
# Usage: make <target>

.PHONY: help build start stop restart logs shell test clean rebuild

# Default target
help:
	@echo "FastAPI Docker Development Commands"
	@echo "===================================="
	@echo "make build      - Build Docker image"
	@echo "make start      - Start development container"
	@echo "make stop       - Stop container"
	@echo "make restart    - Restart container"
	@echo "make logs       - View container logs (follow)"
	@echo "make shell      - Access container shell"
	@echo "make test       - Run tests inside container"
	@echo "make clean      - Remove container and image"
	@echo "make rebuild    - Rebuild image and restart container"
	@echo "make status     - Show container status"
	@echo "make health     - Check API health"

# Build Docker image
build:
	@echo "ğŸ“¦ Building Docker image..."
	docker build -t fastapi-backend-dev .
	@echo "âœ… Build complete"

# Start container with bind mount
start:
	@echo "ğŸš€ Starting development container..."
	@docker rm -f fastapi-dev 2>/dev/null || true
	docker run -d \
		--name fastapi-dev \
		-p 8000:8000 \
		-v "$$(pwd):/app" \
		--env-file .env \
		fastapi-backend-dev
	@echo "âœ… Container started"
	@echo "ğŸŒ API: http://localhost:8000"
	@echo "ğŸ“š Docs: http://localhost:8000/docs"

# Stop container
stop:
	@echo "ğŸ›‘ Stopping container..."
	docker stop fastapi-dev
	@echo "âœ… Container stopped"

# Restart container
restart:
	@echo "ğŸ”„ Restarting container..."
	docker restart fastapi-dev
	@echo "âœ… Container restarted"

# View logs
logs:
	@echo "ğŸ“‹ Viewing logs (Ctrl+C to exit)..."
	docker logs -f fastapi-dev

# Access container shell
shell:
	@echo "ğŸš Accessing container shell..."
	docker exec -it fastapi-dev bash

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	docker exec fastapi-dev pytest

# Clean up
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker rm -f fastapi-dev 2>/dev/null || true
	docker rmi fastapi-backend-dev 2>/dev/null || true
	@echo "âœ… Cleanup complete"

# Rebuild everything
rebuild: clean build start
	@echo "âœ… Rebuild complete"

# Show container status
status:
	@echo "ğŸ“Š Container Status:"
	@docker ps -a --filter "name=fastapi-dev" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# Check API health
health:
	@echo "ğŸ¥ Checking API health..."
	@curl -s http://localhost:8000/health | python -m json.tool || echo "âŒ API not responding"

# Docker Compose commands
compose-up:
	@echo "ğŸš€ Starting with Docker Compose..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… Services started"

compose-down:
	@echo "ğŸ›‘ Stopping Docker Compose services..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… Services stopped"

compose-logs:
	@echo "ğŸ“‹ Viewing Docker Compose logs..."
	docker-compose -f docker-compose.dev.yml logs -f
